<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勤怠管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif, 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .main-container { max-width: 500px; margin: 0 auto; }
        .page { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .bottom-nav { box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .badge { transform: scale(0.8) translate(50%, -50%); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="main-container bg-white min-h-screen">
        <!-- ======================= LOGIN PAGE ======================= -->
        <div id="login-page" class="page flex flex-col items-center justify-center min-h-screen p-6">
            <i class="fa-solid fa-clock-rotate-left text-5xl text-blue-600 mb-6"></i>
            <h1 class="text-3xl font-bold mb-2">勤怠管理システム</h1>
            <p class="text-gray-500 mb-8">アカウントにログインしてください</p>
            <form id="login-form" class="w-full space-y-4">
                <input type="text" id="username" placeholder="ユーザーID" class="w-full px-4 py-3 border rounded-lg" required>
                <input type="password" id="password" placeholder="パスワード" class="w-full px-4 py-3 border rounded-lg" required>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">ログイン</button>
                <p id="login-error" class="text-red-500 text-sm text-center !mt-2 hidden"></p>
            </form>
        </div>

        <!-- ======================= MAIN CONTENT AREA (LOGGED IN) ======================= -->
        <div id="main-content" class="hidden">
            <main id="page-container" class="pb-20"></main>
            <nav id="bottom-navigation" class="bottom-nav fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white flex justify-around">
                <button data-target="user-dashboard-page" class="nav-btn flex-1 py-3 text-center text-blue-600"><i class="fas fa-home text-xl"></i><span class="block text-xs">ホーム</span></button>
                <button data-target="user-history-page" class="nav-btn flex-1 py-3 text-center text-gray-500"><i class="fas fa-list-alt text-xl"></i><span class="block text-xs">勤怠履歴</span></button>
                <button data-target="user-approvals-page" class="nav-btn flex-1 py-3 text-center text-gray-500 relative">
                    <i class="fas fa-check-to-slot text-xl"></i><span class="block text-xs">承認</span>
                    <span id="approval-badge" class="badge absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden"></span>
                </button>
                <button data-target="user-request-page" class="nav-btn flex-1 py-3 text-center text-gray-500"><i class="fas fa-paper-plane text-xl"></i><span class="block text-xs">各種申請</span></button>
                <button id="logout-btn" class="flex-1 py-3 text-center text-gray-500"><i class="fas fa-sign-out-alt text-xl"></i><span class="block text-xs">ログアウト</span></button>
            </nav>
        </div>
    </div>
    
    <!-- Page Templates -->
    <template id="template-user-dashboard-page">
        <div class="page p-6 space-y-6">
            <div class="bg-blue-50 p-4 rounded-lg"><p class="text-lg">ようこそ、<span id="user-name-display" class="font-bold"></span> さん</p></div>
            <div class="text-center p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-lg font-semibold mb-4">打刻用QRコード (1分更新)</h2>
                <div id="qrcode" class="flex justify-center items-center h-48 w-48 mx-auto"></div>
                <p class="text-sm text-gray-500 mt-4">有効期限: <span id="qr-expiry"></span></small>
            </div>
        </div>
    </template>
    
    <template id="template-user-history-page">
        <div class="page p-6">
            <h1 class="text-2xl font-bold mb-4">勤怠履歴</h1>
            <div id="history-list" class="space-y-3"></div>
        </div>
    </template>

    <template id="template-user-approvals-page">
        <div class="page p-6">
            <h1 class="text-2xl font-bold mb-4">承認待ちの申請</h1>
            <div id="approval-list" class="space-y-4"></div>
        </div>
    </template>

    <template id="template-user-request-page">
        <div class="page p-6">
            <h1 class="text-2xl font-bold mb-4">各種申請</h1>
            <form id="request-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">申請種別</label>
                    <select id="request-type" name="request-type" class="mt-1 block w-full py-2 px-3 border rounded-md" required>
                        <option>直行事前申請</option><option>直行報告</option><option>直帰事前申請</option><option>直帰報告</option>
                        <option>打刻漏れ届</option><option>時間外労働申請</option><option>遅延証明</option><option>シフト勤務申請</option>
                        <option>休日出勤申請</option><option>有給休暇申請</option><option>遅刻届</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">承認者（上司）</label>
                    <select id="request-approver" name="request-approver" class="mt-1 block w-full py-2 px-3 border rounded-md" required></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">詳細・理由</label>
                    <textarea id="request-details" name="request-details" rows="4" class="mt-1 block w-full p-2 border rounded-md" required></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">位置情報を付与して申請</button>
                <p id="request-status" class="text-center h-4"></p>
            </form>
        </div>
    </template>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'https://punch.edps.uk';
        let currentUser = null;
        let qrCodeInterval = null;

        const mainContent = document.getElementById('main-content');
        const pageContainer = document.getElementById('page-container');
        const loginPage = document.getElementById('login-page');

        const api = async (endpoint, method = 'GET', body = null) => {
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' }};
                if (currentUser) options.headers['X-User-ID'] = currentUser.id;
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || `HTTPエラー`);
                return data;
            } catch (error) {
                console.error('API Error:', error);
                alert(`エラー: ${error.message}`);
                return null;
            }
        };

        const showPage = (pageId) => {
            const template = document.getElementById(`template-${pageId}`);
            if (!template) return;
            pageContainer.innerHTML = template.innerHTML;
            document.querySelectorAll('#bottom-navigation .nav-btn').forEach(btn => {
                const target = btn.dataset.target;
                btn.classList.toggle('text-blue-600', target === pageId);
                btn.classList.toggle('text-gray-500', target !== pageId);
            });
            const pageInitializers = {
                'user-dashboard-page': initDashboard,
                'user-history-page': loadHistory,
                'user-approvals-page': loadApprovals,
                'user-request-page': initRequestForm
            };
            pageInitializers[pageId]?.();
        };

        const generateQRCode = () => {
            const qrContainer = document.getElementById('qrcode');
            if (!qrContainer || !currentUser) return;
            qrContainer.innerHTML = '';
            const timestamp = Date.now();
            new QRCode(qrContainer, { text: JSON.stringify({ userId: currentUser.id, ts: timestamp }), width: 180, height: 180 });
            document.getElementById('qr-expiry').textContent = new Date(timestamp + 60000).toLocaleTimeString();
        };

        const initDashboard = () => {
            document.getElementById('user-name-display').textContent = currentUser.name;
            generateQRCode();
            if (qrCodeInterval) clearInterval(qrCodeInterval);
            qrCodeInterval = setInterval(generateQRCode, 60000);
        };

        const loadHistory = async () => {
            const list = document.getElementById('history-list');
            const data = await api(`/api/history/${currentUser.id}`);
            if (data?.logs) {
                list.innerHTML = data.logs.length ? data.logs.map(log => `
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <p class="font-semibold">${log.type}</p>
                        <p class="text-sm text-gray-500">${new Date(log.timestamp).toLocaleString()}</p>
                    </div>`).join('') : '<p>勤怠履歴はありません。</p>';
            }
        };

        const loadApprovals = async () => {
            const list = document.getElementById('approval-list');
            const data = await api(`/api/requests/approvals/${currentUser.id}`);
            if (data?.requests) {
                list.innerHTML = data.requests.length ? data.requests.map(r => `
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-bold">${r.type} <span class="text-xs font-normal">(${r.requestorName})</span></p>
                        <p class="text-sm my-2 p-2 bg-gray-50 rounded">${r.details}</p>
                        <div class="flex justify-end space-x-2 mt-2">
                            <button class="approval-action-btn bg-red-500 text-white px-3 py-1 rounded" data-requestid="${r.id}" data-action="rejected">却下</button>
                            <button class="approval-action-btn bg-green-500 text-white px-3 py-1 rounded" data-requestid="${r.id}" data-action="approved">承認</button>
                        </div>
                    </div>`).join('') : '<p>承認待ちの申請はありません。</p>';
                
                list.addEventListener('click', async e => {
                    if(e.target.classList.contains('approval-action-btn')) {
                        const { requestid, action } = e.target.dataset;
                        await api(`/api/requests/${requestid}/status`, 'POST', { status: action });
                        loadApprovals();
                        updateApprovalBadge();
                    }
                });
            }
        };

        const initRequestForm = async () => {
            const select = document.getElementById('request-approver');
            const data = await api('/api/users');
            if(data?.users) {
                select.innerHTML = data.users
                    .filter(u => u.id !== currentUser.id) // Exclude self
                    .map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            }
            document.getElementById('request-form').addEventListener('submit', handleRequestSubmit);
        };

        const handleRequestSubmit = async (e) => {
            e.preventDefault();
            const statusEl = document.getElementById('request-status');
            statusEl.textContent = '位置情報取得中...';
            navigator.geolocation.getCurrentPosition(
                async pos => {
                    statusEl.textContent = '申請を送信中...';
                    const form = new FormData(e.target);
                    const data = {
                        requestorId: currentUser.id, requestorName: currentUser.name,
                        type: form.get('request-type'), approverId: form.get('request-approver'),
                        details: form.get('request-details'),
                        location: { lat: pos.coords.latitude, lon: pos.coords.longitude }
                    };
                    const res = await api('/api/requests', 'POST', data);
                    if (res?.status === 'success') {
                        statusEl.textContent = '申請が送信されました！';
                        e.target.reset();
                        setTimeout(() => showPage('user-dashboard-page'), 2000);
                    } else { statusEl.textContent = '申請失敗'; }
                },
                () => { alert('位置情報を取得できませんでした。'); statusEl.textContent = ''; }
            );
        };

        const updateApprovalBadge = async () => {
            const badge = document.getElementById('approval-badge');
            const data = await api(`/api/requests/approvals/${currentUser.id}`);
            const pendingCount = data?.requests?.length || 0;
            badge.textContent = pendingCount;
            badge.classList.toggle('hidden', pendingCount === 0);
        };
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const res = await api('/api/login', 'POST', { username, password });
            if (res?.status === 'success') {
                currentUser = res.user;
                loginPage.classList.add('hidden');
                mainContent.classList.remove('hidden');
                showPage('user-dashboard-page');
                updateApprovalBadge();
            } else {
                document.getElementById('login-error').textContent = res?.message || 'ログイン失敗';
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            currentUser = null;
            if(qrCodeInterval) clearInterval(qrCodeInterval);
            mainContent.classList.add('hidden');
            loginPage.classList.remove('hidden');
            document.getElementById('login-form').reset();
        });
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
            if(btn.id !== 'logout-btn') {
                btn.addEventListener('click', (e) => showPage(e.currentTarget.dataset.target));
            }
        });
    });
    </script>
</body>
</html>